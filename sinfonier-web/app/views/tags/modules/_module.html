<div id="module-${_module.getId()}" data-id="${_module.getId()}"
     class="#{if _size == "small"} col-sm-6 col-xs-12 #{/if} #{else } col-lg-12 #{/else} module">
  <div class="panel panel-default">

  #{if _wc && !_module.isOwner(_wc?.getCurrentUser()) && _module.getStatus().equals(models.SinfonierConstants.Module.STATUS_PUBLISHED) && !_version?.getMyTools()?.hasAdded(_wc?.getCurrentUser())}
    <div class="panel-heading">
        #{form @Modules.addToMyTools(_module.getId(), _version.getVersionCode())}
          <div class="row">
            <button id="module-${_module?.getId()}-button-addTools" class="btn-black-width btn btn-link pull-right align-right"
                    type="submit">&{'Modules.btn.addTools'}<i class="material-icons">build</i></button>
          </div>
        #{/form}
    </div>
  #{/if}
  #{elseif _wc && !_module.isOwner(_wc?.getCurrentUser()) && _version?.getMyTools()?.hasAdded(_wc?.getCurrentUser())}
    <div class="panel-heading">
        #{form @Modules.removeToMyTools(_module.getId(), _version.getVersionCode())}
          <div class="row">
            <button id="module-${_module?.getId()}-button-removeTools" class="btn-black-width btn btn-link pull-right align-right"
                    type="submit">&{'Modules.btn.removeTools'}<i class="material-icons">build</i></button>
          </div>
        #{/form}
    </div>
  #{/elseif}

    <div class="panel-body">
      <div class="row">
        <div class="col-xs-12">
          <h2 class="title inline pull-left">
          #{if _size == "small"}
            <img id="module-${_module?.getId()}-img-type" class="icon-xs"
                 src="/public/images/icons/${_module?.getType()}.png" alt="Module icon by type">
          #{/if}
            <a id="module-${_module?.getId()}-a-title" href="@{Modules.module(_module?.getName())}" class="btn btn-link"
               style="font-size: 20px;">${_module?.getName()}</a>
          #{if _size != "small" && _module.getVisibleVersionsToUser(_wc?.getCurrentUser()).size() > 1}
            <img id="module-${_module?.getId()}-img-multi-version" class="icon-xs"
                 src="/public/images/icons/application_cascade.png" title="&{'Modules.Module.multipleVersions'}">
          #{/if}
          </h2>
        </div>
      </div>

    #{if _size != "small"}
      <div class="row no-overf">
        <div class="col-sm-8 col-xs-12">
          <p id="module-${_module?.getId()}-p-type"><span class="bold">&{'Modules.form.type'}:</span> ${_module?.getType()}</p>
          <p id="module-${_module?.getId()}-p-status"><span class="bold">&{'Modules.form.status'}:</span> ${_version?.getStatus()}
              #{if _size =="large" && _version?.getBuildStatus()?.equals(models.SinfonierConstants.ModuleVersion.BUILD_STATUS_SUCCESS)}
                <br>
                <small class="text-success">&{'Modules.build.status'}: &{'Modules.build.status.success'}</small>
              #{/if}
              #{elseif _size =="large" && _version?.getBuildStatus()?.equals(models.SinfonierConstants.ModuleVersion.BUILD_STATUS_FAILURE)}
                <br>
                <small class="text-danger">&{'Modules.build.status'}: &{'Modules.build.status.failure'}</small>
              #{/elseif}
          </p>

        *{ PUBLISHED, PRIVATIZE AND RECHECK BUTTONS }*
          <div class="row">
              #{if _size == 'large' && _module?.isOwner(_wc?.getCurrentUser()) && _version?.getStatus()?.equals(models.SinfonierConstants.Module.STATUS_PUBLISHED)}
                <div class="col-lg-4">
                    #{form @Modules.privatize(_module?.getId(), _version?.getVersionCode()), class:'form-inline'}
                      <button id="module-${_module?.getId()}-button-privatize" type="submit" class="btn btn-blue">
                      &{'Modules.btn.privatize'}</button>
                    #{/form}
                </div>
              #{/if}
              #{elseif _size == 'large' && _module?.isOwner(_wc?.getCurrentUser()) && _version?.getStatus()?.equals(models.SinfonierConstants.Module.STATUS_PRIVATE)}
                <div class="col-lg-4">
                    #{form @Modules.publish(_module?.getId(), _version?.getVersionCode()), class:'form-inline'}
                      <button id="module-${_module?.getId()}-button-publish" type="submit" class="btn btn-blue">
                      &{'Modules.btn.publish'}</button>
                    #{/form}
                </div>
              #{/elseif}
              #{elseif _size == 'large' && _module?.isOwner(_wc?.getCurrentUser()) && _version?.getStatus()?.equals(models.SinfonierConstants.Module.STATUS_DEV)}
              *{NOTE: if it is from gist I will show the modal if not a will do straight the request}*
                <div class="col-lg-4">
                    #{if _version?.isFromGist()}
                      <button type="button" id="module-${_module?.getId()}-button-send-request-petition" class="btn btn-blue"
                              data-toggle="modal" data-target="#confirmModalForSendRequest">
                      &{'Modules.btn.sendValidation'}
                      </button>
                    #{/if}
                    #{else }
                        #{form @Modules.recheck(_module?.getId(), _version?.getVersionCode()), class:'form-inline'}
                          <button id="module-${_module?.getId()}-button-sendValidation" type="submit" class="btn btn-blue">
                          &{'Modules.btn.sendValidation'}</button>
                        #{/form}
                    #{/else}
                </div>
              #{/elseif}

          *{ VALIDATE OR DECLINED BUTTONS }*
              #{if _size == 'large' && _wc?.getCurrentUser()?.isAdminUser() && _version?.getStatus()?.equals(models.SinfonierConstants.Module.STATUS_PENDING)}
                <div class="col-lg-4">
                  <button type="button" id="module-${_module?.getId()}-button-decline-validation" class="btn btn-blue"
                          data-toggle="modal" data-target="#declineModal">&{'Modules.btn.decline'}</button>
                </div>

                <div class="col-lg-4">
                    #{form @Modules.validate(_module?.getId(), _version?.getVersionCode()), class:'form-inline'}
                        #{if _version?.getBuildStatus()?.equals(models.SinfonierConstants.ModuleVersion.BUILD_STATUS_SUCCESS)}
                          <button id="module-${_module?.getId()}-button-validate" type="submit" class="btn btn-blue">
                          &{'Modules.btn.validate'}</button>
                        #{/if}
                        #{else }
                          <button id="module-${_module?.getId()}-button-validate-disabled" type="submit" class="btn btn-blue"
                                  disabled>&{'Modules.btn.validate'}</button>
                        #{/else}
                    #{/form}
                </div>
              #{/if}
          </div>

          <p id="module-${_module?.getId()}-p-language">
            <span class="bold">&{'Modules.form.language'}:</span> ${_module?.getLanguage()}
          </p>
        </div>
        <div class="col-lg-4 col-md-4 col-sm-4 col-xs-12">
            #{if _module?.getIcon() != null}
              <img id="module-${_module?.getId()}-img-icon" src="${_module?.getIcon()}" alt="${_module?.getName()}"
                   class="module-icon"/>
            #{/if}
            #{else}
                #{if _module?.getType() == "spout"}
                  <!-- <img id="module-${_module?.getId()}-img-icon" src="@{'/public/images/modules/spout-big.png'}"
                       alt="${_module?.getName()}" class="module-icon"/> -->
                       <i class="material-icons pull-right big-icon">invert_colors</i>
                #{/if}
                #{elseif _module?.getType() == "bolt"}
                  <!-- <img id="module-${_module?.getId()}-img-icon" src="@{'/public/images/modules/bolt-big.png'}"
                       alt="${_module?.getName()}" class="module-icon"/> -->
                       <i class="material-icons pull-right big-icon">flash_on</i>
                #{/elseif}
                #{elseif _module?.getType() == "drain"}
                  <!-- <img id="module-${_module?.getId()}-img-icon" src="@{'/public/images/modules/drain-big.png'}"
                       alt="${_module?.getName()}" class="module-icon"/> -->
                       <i class="material-icons pull-right big-icon">group_work</i>
                #{/elseif}
            #{/else}
        </div>
      </div>
    #{/if}

    #{if _version.isFromGist() && _size != "small" && !_version.getStatus().equals(models.SinfonierConstants.Module.STATUS_PENDING)}
      <div class="row">
        <div class="col-lg-12">
          <p><span class="bold">&{'Modules.form.code.url'}:</span>
            <a id="module-${_module?.getId()}-a-url" href="${_version?.getSourceCodeURL()}" target="_blank"
               class="btn btn-link">${_version?.getSourceCodeURL()}</a>
          </p>
        </div>
      </div>
    #{/if}

      <!-- DESCRIPTION -->
      <div class="row">
        <div class="col-lg-12">
          <span class="bold">&{'Modules.form.description'}:</span>
          <p id="module-${_module?.getId()}-p-description">${_version.getDescription()}</p>
        </div>
      </div>

      <!-- EXTERNAL LIBRARIES -->
    #{if _size == "large" && _version?.hasLibraries()}
      <div class="row">
        <div class="col-lg-12">
          <p>
            <span class="bold">&{'Modules.form.libraries'}:</span>
          <table class="table sinfonier table-bordered">
            <thead>
            <tr>
              <th>&{'Modules.form.name'}</th>
              <th>&{'Modules.form.lib.url'}</th>
            </tr>
            </thead>
            <tbody>
                #{list items:_version.getLibraries(), as:'library'}
                <tr id="module-${_module?.getId()}-tr-library${library_index}">
                  <td>${library.getName()}</td>
                  <td>${library.getUrl()}</td>
                </tr>
                #{/list}
            </tbody>
          </table>
          </p>
        </div>
      </div>
    #{/if}

    #{if _version.hasFields() && _size != "small"}
      <div class="row">
        <div class="col-lg-12">
          <p><span class="bold">&{'Modules.form.fields'}:</span>
          <table class="table sinfonier table-bordered">
            <thead>
            <tr>
              <th>&{'Modules.form.name'}</th>
              <th>&{'Modules.form.label'}</th>
              <th>&{'Modules.form.type'}</th>
            </tr>
            </thead>

            <tbody>
                #{list items:_version.getFields(), as:'field'}
                <tr id="module-${_module?.getId()}-tr-field${field_index}">
                  <td>#{if field.isRequired()}
                    <span style="text-decoration: underline;">${field.getName()}</span>
                  #{/if}
                      #{else}
                      ${field.getName()}
                      #{/else}
                  </td>
                  <td>${field.getLabel()}</td>
                  <td>${field.getType()}</td>
                </tr>
                #{/list}
            </tbody>
          </table>
          </p>
        </div>
      </div>
    #{/if}

    #{if _version.getTickTuple() && _size != "small"}
      <div class="row">
        <div class="col-lg-12">

            <span class="bold">&{'Modules.form.ticktuple'}:</span>
          <table class="table sinfonier table-bordered">
              <thead>
            <tr class="active">
              <th>&{'Modules.form.name'}</th>
              <th>&{'Modules.form.label'}</th>
              <th>&{'Modules.form.type'}</th>
            </tr>
              </thead>
              <tbody>
            <tr id="module-${_module?.getId()}-tr-field${_version.getFields()?.size() + 1}">
              <td>#{if _version.getTickTuple().isRequired()}
                <span style="text-decoration: underline;">${_version.getTickTuple().getName()}</span>
              #{/if}
                  #{else}
                  ${_version.getTickTuple().getName()}
                  #{/else}
              </td>
              <td>${_version.getTickTuple().getLabel()}</td>
              <td>${_version.getTickTuple().getType()}</td>
            </tr></tbody>
          </table>

        </div>
      </div>
    #{/if}

    #{if !_module.getStatus().equals(models.SinfonierConstants.Module.STATUS_PREDEFINED)}
      <!-- SOME DETAILS -->
      <div class="row details-section">
        <div class="col-lg-12">

            <p id="module-${_module?.getId()}-p-createBy" class="details">
                #{if session.username && controllers.Secure.Security.invoke("check", "USER_READ_PROFILES")}
                    #{if _size != "small"}
                    &{'Modules.index.create_by', _module.getAuthor()?.getEmail(), _module.getAuthor()?.getName(), _module.getAuthor()?.getEmail(), _version.getCreatedAt()?.format(play.Play.configuration.getProperty("date.format"))}
                    #{/if}
                    #{else}
                    &{'Modules.index.create_by_short', _module.getAuthor()?.getEmail(), _module.getAuthor()?.getName(), _version.getCreatedAt()?.format(play.Play.configuration.getProperty("date.format"))}
                    #{/else}
                #{/if}
            #{else}
            &{'Modules.index.create_by_text', _module.getAuthor()?.getName(), _version.getCreatedAt()?.format(play.Play.configuration.getProperty("date.format"))}
            #{/else}
            </p>

        </div>
      </div>
    #{/if}

      <!-- VOTE -->
    #{if _vote}
      <div class="row vote-section">
        <div class="col-lg-12">
          <div class="well">
            <h3 class="display-inline">
              <small>&{'Modules.details.vote'}:</small>
              <ul class="stars list-inline list-unstyled" data-value="${_module.getAverageRate()}">
                  #{list items:[1,2,3,4,5], as:'index'}
                    <li id="module-${_module?.getId()}-li-start${index}" data-value="${index}"
                        #{if !_module.isOwner(_wc?.getCurrentUser()) && !_module.getRatings()?.hasVoted(_wc?.getCurrentUser())}
                        onclick="handleVote(this, ${index})"
                        #{/if}>
                      <i class="material-icons star-vote">star_border</i>
                    </li>
                  #{/list}
              </ul>
            </h3>
          </div>
        </div>
      </div>
    #{/if}


      <!-- BUTTONS -->
    #{if _size == "large"}
      <div class="row">
        <!-- CODE -->
          #{if (!_version.isFromGist() || _version.getStatus().equals(models.SinfonierConstants.Module.STATUS_PENDING))}
            <div class="col-lg-2 col-sm-3">
              <button id="module-${_module?.getId()}-button-sourceCode" class="btn btn-blue" type="button" data-toggle="collapse"
                      data-target="#collapseCode${_module.getId()}" aria-expanded="false"
                      aria-controls="collapseCode${_module.getId()}"
                      onclick="handleModuleTemplate(this, '${_module.getName()}', '${_module.getLanguage()}', '${_module.getType()}', true, '${_version.getSourceCodeBase64()}')">
              &{'Modules.btn.sourceCode'}
              </button>
            </div>
          #{/if}

        <!-- EXPORT -->
        <div class="col-sm-2">
            #{form @Modules.export(_module?.getId(), _version?.getVersionCode()), class:"display-inline"}
              <button id="module-${_module?.getId()}-button-export" class="btn btn-blue " type="submit">
              &{'Modules.btn.export'}</button>
            #{/form}
        </div>

          #{if _module.hasWritePermission(_wc?.getCurrentUser())}
            <!-- DELETE -->
              #{if _version.getStatus().equals(models.SinfonierConstants.Module.STATUS_DEV)}
                <div class="col-sm-2">
                  <button id="module-${_module?.getId()}-button-delete" class="btn btn-cancel " type="button"
                          data-toggle="modal" data-target="#confirmModal">
                  &{'Modules.btn.delete'}
                  </button>
                </div>
              #{/if}

            <!-- EDIT -->
            <div class="col-sm-2">
              <a id="module-${_module?.getId()}-button-edit"
                 href="@{Modules.edit(_module?.getName(), _version?.getVersionCode())}" class="btn btn-ok ">
                  #{if _version.getStatus().equals(models.SinfonierConstants.Module.STATUS_DEV)}
                  &{'Modules.btn.edit'}
                  #{/if}
                  #{else}
              &{'Modules.btn.newVersion'}
              #{/else}
              </a>
            </div>
          #{/if}


        <!-- COMPLAINS -->
          #{if !_module?.getComplains()?.hasComplained(_wc?.getCurrentUser()) && !_module?.isOwner(_wc?.getCurrentUser()) && _module.getStatus().equals(models.SinfonierConstants.Module.STATUS_PUBLISHED)}
            <div class="col-lg-offset-1 col-sm-3 pull-right">
              <button type="button" id="module-${_module?.getId()}-a-complain" class="btn btn-blue pull-right"
                      title="&{'Modules.details.complain'}" onclick="handleComplain()"> &{'Modules.details.complain'}
                <i class="material-icons cursor-pointer pdl5">feedback</i>
              </button>
            </div>
          #{/if}

      </div>
    #{/if}

      <div class="row">
        <div class="col-xs-12">
          <div class="collapse" id="collapseCode${_module.getId()}">
              <br \>
            <textarea id="code" cols="30" rows="10" class="form-control">${_version?.getSourceCode()}</textarea>
          </div>
        </div>
      </div>

    #{form @Modules.vote(), method:'POST', id:'form-' + _module.getId(), class:'form-horizontal form-vote display-none'}
      <input type="hidden" name="rate" value="" class="rate">
      <input type="hidden" name="module_name" value="${_module.getName()}">

      <!-- Message -->
      <div class="form-group">
        <label for="name"
               class="col-lg-2 col-md-2 col-sm-2 col-xs-12 control-label">&{'Modules.details.vote.msg'}</label>
        <div class="col-lg-10 col-md-10 col-sm-10 col-xs-12">
          <textarea name="msg" id="msg" rows="10" class="form-control"></textarea>
        </div>
      </div>

      <div class="row form-group">
        <div class="col-lg-6"></div>
        <div class="col-lg-6 pull-right display-inline">
          <a id="module-${_module?.getId()}-button-cancelVote" class="btn btn-cancel btn-inline" onclick="cancelVote()">
          &{'Modules.btn.cancel'}</a>
          <button id="module-${_module?.getId()}-button-vote" type="submit" class="btn btn-blue btn-inline">
          &{'Modules.btn.vote'}</button>
        </div>
      </div>
    #{/form}
    #{form @Modules.complain(), method:'POST', id:'complain-' + _module.getId(), class:'form-horizontal form-complain display-none'}
      <input type="hidden" name="module_name" value="${_module.getName()}">

      <!-- Message -->
      <div class="row form-group">
        <label for="name"
               class="col-lg-2 col-md-2 col-sm-2 col-xs-12 control-label">&{'Modules.details.complain.msg'}</label>
        <div class="col-lg-10 col-md-10 col-sm-10 col-xs-12">
          <textarea name="msg" id="msgComplain" rows="10" class="form-control" required></textarea>
        </div>
      </div>

      <div class="row form-group">
        <div class="col-lg-6"></div>
        <div class="col-lg-6 pull-right display-inline">
          <a id="module-${_module?.getId()}-button-cancelComplain" class="btn btn-cancel btn-inline" onclick="cancelComplain()">
          &{'Modules.btn.cancel'}</a>
          <button id="module-${_module?.getId()}-button-complain" type="submit" class="btn btn-blue btn-inline">
          &{'Modules.btn.complain'}</button>
        </div>
      </div>
    #{/form}
    </div>
  </div>

#{if _size == "large"}
  <div id="module-data" style="display: none" data-id="${_module.getId()}"></div>
  <div id="panel-${_module.getId()}" class="module-over-panel">
    <div class="col-xs-12 img-loading">
      <i class="fa fa-spinner fa-pulse" aria-hidden="true"></i>
    </div>
  </div>
#{/if}

</div>

#{if _size == "large"}

<!-- Remove modal confirmation -->
<div class="modal fade" id="confirmModal" tabindex="-1" role="dialog" aria-labelledby="confirmModal">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">&{'Modules.details.delete.title'}</h4>
      </div>
      <div class="modal-body">
      &{'Modules.details.delete.text', _module?.getName(), "vc"+_version?.getVersionCode()}
      </div>
      <div class="modal-footer">
          #{form @Modules.remove(_module.getId(), _version.getVersionCode()), method:'POST', id:'remove-' + _module.getId()}
            <button id="module-${_module?.getId()}-button-deleteCancel" type="button" class="btn btn-default btn-modal"
                    data-dismiss="modal">&{'Modules.btn.cancel'}</button>
            <button id="module-${_module?.getId()}-button-deleteOK" type="submit" class="btn btn-cancel btn-modal">
            &{'Modules.btn.delete'}</button>
          #{/form}
      </div>
    </div>
  </div>
</div>

<!-- Send request modal confirmation -->
<div class="modal fade" id="confirmModalForSendRequest" tabindex="-1" role="dialog" aria-labelledby="confirmModalForSendRequest">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">&{'Modules.sendValidation.title'}</h4>
      </div>
      <div class="modal-body">
      &{'Modules.sendValidation.text', _module?.getName(), "vc"+_version?.getVersionCode()}
      </div>
      <div class="modal-footer">
          #{form @Modules.recheck(_module?.getId(), _version?.getVersionCode()), class:'form-inline'}
            <button id="module-${_module?.getId()}-button-deleteCancel" type="button" class="btn btn-default btn-modal"
                    data-dismiss="modal">&{'Modules.btn.cancel'}</button>
            <button id="module-${_module?.getId()}-button-sendValidation" type="submit" class="btn btn-blue btn-modal">
            &{'Modules.btn.sendValidation'}</button>
          #{/form}
      </div>
    </div>
  </div>
</div>

<!-- Decline modal -->
<div class="modal fade" id="declineModal" tabindex="-1" role="dialog" aria-labelledby="declineModal">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="declineModalTitle">&{'Modules.decline.title'}</h4>
      </div>
      <div class="modal-body">
          #{form @Modules.decline(_module.getId(), _version.getVersionCode()), , method:'POST', id:'decline-form-' + _module.getId()}
            <div class="form-group">
              <label for="message">&{'Modules.decline.form.label'}</label>
              <textarea name="message" id="message" cols="30" rows="10" class="form-control"></textarea>
            </div>
          #{/form}
      </div>
      <div class="modal-footer">
        <button id="module-${_module?.getId()}-button-declineCancel" type="button" class="btn btn-default btn-modal"
                data-dismiss="modal">&{'Modules.btn.cancel'}</button>
        <button id="module-${_module?.getId()}-button-declineOk" form="decline-form-${_module.getId()}" type="submit"
                class="btn btn-primary btn-modal">
        &{'Modules.btn.decline'}</button>
      </div>
    </div>
  </div>
</div>

#{/if}
